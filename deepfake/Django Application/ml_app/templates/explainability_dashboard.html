{% extends 'base.html' %}
{% load static %}

{% block title %}Explainability Dashboard - Deepfake Detection{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row">
        <div class="col-12">
            <h2 class="text-center mb-4">
                <i class="fas fa-brain"></i> Deepfake Detection - Explainability Dashboard
            </h2>
            <p class="text-center text-muted">
                "We show WHY the model thinks it's fake - this system can be used in courts, newsrooms, and cybersecurity SOCs."
            </p>
        </div>
    </div>

    <!-- Threat Level Banner -->
    <div class="row mb-4" id="threat-banner">
        <div class="col-12">
            <div class="alert" id="threat-alert" style="display: none;">
                <h4 id="threat-level-text"></h4>
                <p id="threat-explanation"></p>
            </div>
        </div>
    </div>

    <!-- Main Detection Result -->
    {% if prediction %}
    <div class="row mb-4">
        <div class="col-md-6">
            <div class="card">
                <div class="card-header bg-primary text-white">
                    <h5><i class="fas fa-check-circle"></i> Detection Result</h5>
                </div>
                <div class="card-body text-center">
                    <h2 class="{% if prediction.prediction_label == 'FAKE' %}text-danger{% else %}text-success{% endif %}">
                        {{ prediction.prediction_label }}
                    </h2>
                    <p class="lead">Confidence: {{ prediction.confidence|floatformat:1 }}%</p>
                </div>
            </div>
        </div>
        <div class="col-md-6">
            <div class="card">
                <div class="card-header bg-info text-white">
                    <h5><i class="fas fa-shield-alt"></i> Threat Assessment</h5>
                </div>
                <div class="card-body" id="threat-card">
                    <div class="text-center">
                        <div id="threat-score-meter" class="mb-3">
                            <canvas id="threatMeterCanvas" width="200" height="100"></canvas>
                        </div>
                        <h4 id="threat-level-display">Loading...</h4>
                        <div id="threat-recommendations" class="text-left mt-3" style="display: none;">
                            <h6>Recommendations:</h6>
                            <ul id="threat-recommendations-list"></ul>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    {% endif %}

    <!-- Grad-CAM Heatmaps -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card">
                <div class="card-header bg-warning text-dark">
                    <h5><i class="fas fa-fire"></i> Grad-CAM Explanations - Where the Model Looks</h5>
                </div>
                <div class="card-body">
                    <p class="text-muted">
                        These heatmaps show which regions of each frame the model focused on when making its prediction.
                        Warmer colors (red/yellow) indicate higher attention areas.
                    </p>
                    <div id="gradcam-gallery" class="row">
                        {% if explainability.gradcam_images %}
                            {% for img in explainability.gradcam_images %}
                            <div class="col-md-3 col-sm-4 mb-3">
                                <img src="{{ MEDIA_URL }}{{ img }}" class="img-fluid gradcam-img" 
                                     alt="Grad-CAM Frame" onclick="showFullImage(this.src)">
                            </div>
                            {% endfor %}
                        {% else %}
                            <div class="col-12">
                                <button class="btn btn-warning" id="generate-gradcam-btn" onclick="generateGradCAM()">
                                    <i class="fas fa-fire"></i> Generate Grad-CAM Heatmaps
                                </button>
                            </div>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Probability Timeline -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card">
                <div class="card-header bg-success text-white">
                    <h5><i class="fas fa-chart-line"></i> Frame-wise Fake Probability Timeline</h5>
                </div>
                <div class="card-body">
                    <p class="text-muted">
                        "Deepfakes fail in temporal consistency" - This chart shows how the fake probability 
                        changes across frames. Sudden spikes may indicate manipulation.
                    </p>
                    <div style="height: 300px;">
                        <canvas id="timelineChart"></canvas>
                    </div>
                    <div id="timeline-stats" class="mt-3 row">
                        <div class="col-md-3">
                            <div class="stat-box">
                                <span class="stat-label">Mean Probability</span>
                                <span class="stat-value" id="stat-mean">-</span>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="stat-box">
                                <span class="stat-label">Temporal Variance</span>
                                <span class="stat-value" id="stat-variance">-</span>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="stat-box">
                                <span class="stat-label">Consistency Score</span>
                                <span class="stat-value" id="stat-consistency">-</span>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="stat-box">
                                <span class="stat-label">Anomalies Detected</span>
                                <span class="stat-value" id="stat-anomalies">-</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Forensics Metrics -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card">
                <div class="card-header bg-dark text-white">
                    <h5><i class="fas fa-microscope"></i> Forensics Investigation Panel</h5>
                </div>
                <div class="card-body">
                    <p class="text-muted">
                        "This is not a classifier, it's an investigation tool" - Detailed forensic metrics 
                        for expert analysis.
                    </p>
                    <div class="row" id="forensics-panel">
                        <div class="col-md-3">
                            <div class="forensic-metric">
                                <div class="metric-icon"><i class="fas fa-user-circle"></i></div>
                                <div class="metric-label">Face Consistency</div>
                                <div class="metric-value" id="forensic-face">-</div>
                                <div class="progress">
                                    <div class="progress-bar" id="forensic-face-bar" role="progressbar"></div>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="forensic-metric">
                                <div class="metric-icon"><i class="fas fa-eye"></i></div>
                                <div class="metric-label">Eye Blink Pattern</div>
                                <div class="metric-value" id="forensic-blink">-</div>
                                <div class="progress">
                                    <div class="progress-bar" id="forensic-blink-bar" role="progressbar"></div>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="forensic-metric">
                                <div class="metric-icon"><i class="fas fa-clock"></i></div>
                                <div class="metric-label">Temporal Stability</div>
                                <div class="metric-value" id="forensic-temporal">-</div>
                                <div class="progress">
                                    <div class="progress-bar" id="forensic-temporal-bar" role="progressbar"></div>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="forensic-metric">
                                <div class="metric-icon"><i class="fas fa-compress"></i></div>
                                <div class="metric-label">Compression Artifacts</div>
                                <div class="metric-value" id="forensic-artifacts">-</div>
                                <div class="progress">
                                    <div class="progress-bar bg-danger" id="forensic-artifacts-bar" role="progressbar"></div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="text-center mt-3">
                        <a href="{% url 'ml_app:forensics_dashboard' %}" class="btn btn-outline-dark">
                            <i class="fas fa-search"></i> Open Full Forensics Dashboard
                        </a>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Fake Type Classification -->
    <div class="row mb-4">
        <div class="col-md-6">
            <div class="card h-100">
                <div class="card-header bg-danger text-white">
                    <h5><i class="fas fa-tags"></i> Fake Type Classification</h5>
                </div>
                <div class="card-body">
                    <p class="text-muted">"We don't just detect fake, we classify it."</p>
                    <div id="fake-type-result" class="text-center">
                        <h3 id="fake-type-label">-</h3>
                        <p id="fake-type-confidence">Confidence: -</p>
                        <p id="fake-type-explanation" class="small text-muted"></p>
                    </div>
                    <div id="fake-type-evidence" class="mt-3" style="display: none;">
                        <h6>Evidence:</h6>
                        <ul id="fake-type-evidence-list"></ul>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-6">
            <div class="card h-100">
                <div class="card-header bg-purple text-white" style="background-color: #6f42c1;">
                    <h5><i class="fas fa-volume-up"></i> Audio-Video Consistency</h5>
                </div>
                <div class="card-body">
                    <p class="text-muted">Cross-modal analysis for lip-sync and audio authenticity.</p>
                    <div class="row text-center" id="multimodal-panel">
                        <div class="col-6">
                            <h4 id="av-sync-score">-</h4>
                            <p class="small">Lip-Sync Score</p>
                        </div>
                        <div class="col-6">
                            <h4 id="audio-spoof-score">-</h4>
                            <p class="small">Audio Authenticity</p>
                        </div>
                    </div>
                    <div class="progress mt-3">
                        <div class="progress-bar bg-purple" id="av-overall-bar" role="progressbar" 
                             style="background-color: #6f42c1;"></div>
                    </div>
                    <p class="text-center mt-2 small" id="av-overall-label">Overall A/V Score: -</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Ethics Panel -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card">
                <div class="card-header bg-secondary text-white">
                    <h5><i class="fas fa-balance-scale"></i> Ethics & Bias Disclosure</h5>
                </div>
                <div class="card-body">
                    <pre class="ethics-summary">{{ ethics_summary }}</pre>
                    <div class="text-center">
                        <a href="{% url 'ml_app:ethics_panel' %}" class="btn btn-secondary">
                            <i class="fas fa-info-circle"></i> View Full Ethics Panel
                        </a>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Quick Actions -->
    <div class="row mb-4">
        <div class="col-12 text-center">
            <a href="{% url 'ml_app:home' %}" class="btn btn-primary btn-lg mr-2">
                <i class="fas fa-upload"></i> Analyze Another Video
            </a>
            <a href="{% url 'ml_app:webcam_detection' %}" class="btn btn-success btn-lg">
                <i class="fas fa-video"></i> Real-Time Webcam Detection
            </a>
        </div>
    </div>
</div>

<!-- Image Modal -->
<div class="modal fade" id="imageModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-body">
                <img id="modalImage" src="" class="img-fluid">
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block js_scripts %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
// Timeline Chart
let timelineChart = null;

function initTimelineChart(data) {
    const ctx = document.getElementById('timelineChart').getContext('2d');
    
    if (timelineChart) {
        timelineChart.destroy();
    }
    
    timelineChart = new Chart(ctx, {
        type: 'line',
        data: data,
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                title: {
                    display: false
                },
                legend: {
                    position: 'top'
                }
            },
            scales: {
                y: {
                    beginAtZero: true,
                    max: 100,
                    title: {
                        display: true,
                        text: 'Probability (%)'
                    }
                },
                x: {
                    title: {
                        display: true,
                        text: 'Frame'
                    }
                }
            }
        }
    });
}

// Update forensics display
function updateForensics(metrics) {
    if (!metrics) return;
    
    const updateMetric = (id, value) => {
        document.getElementById(id).textContent = value.toFixed(1) + '%';
        document.getElementById(id + '-bar').style.width = value + '%';
    };
    
    updateMetric('forensic-face', metrics.face_consistency_score || 0);
    updateMetric('forensic-blink', metrics.eye_blink_score || 0);
    updateMetric('forensic-temporal', metrics.temporal_stability_score || 0);
    updateMetric('forensic-artifacts', metrics.compression_artifact_score || 0);
}

// Update threat display
function updateThreat(threat) {
    if (!threat) return;
    
    const alert = document.getElementById('threat-alert');
    alert.style.display = 'block';
    alert.className = 'alert';
    
    if (threat.level === 'safe') {
        alert.classList.add('alert-success');
    } else if (threat.level === 'suspicious') {
        alert.classList.add('alert-warning');
    } else {
        alert.classList.add('alert-danger');
    }
    
    document.getElementById('threat-level-text').textContent = 
        'Threat Level: ' + threat.level_display;
    document.getElementById('threat-explanation').textContent = threat.explanation;
    document.getElementById('threat-level-display').textContent = 
        threat.level_display + ' (' + threat.overall_score.toFixed(1) + '/100)';
    document.getElementById('threat-level-display').style.color = threat.color_code;
    
    if (threat.recommendations && threat.recommendations.length > 0) {
        const recDiv = document.getElementById('threat-recommendations');
        recDiv.style.display = 'block';
        const recList = document.getElementById('threat-recommendations-list');
        recList.innerHTML = threat.recommendations.map(r => '<li>' + r + '</li>').join('');
    }
}

// Full image view
function showFullImage(src) {
    document.getElementById('modalImage').src = src;
    new bootstrap.Modal(document.getElementById('imageModal')).show();
}
</script>

<!-- Django data passed to JavaScript -->
<script id="django-data" type="application/json">
{
    "video_path": "{{ video_path|default:''|escapejs }}",
    "prediction": {{ prediction|default:'null'|safe }},
    "api_complete_url": "{% url 'ml_app:api_complete' %}",
    "api_threat_url": "{% url 'ml_app:api_threat' %}"
}
</script>

<script>
// Load data on page load
document.addEventListener('DOMContentLoaded', function() {
    // Parse Django data from JSON script tag
    var djangoDataEl = document.getElementById('django-data');
    var djangoData = {};
    try {
        djangoData = JSON.parse(djangoDataEl.textContent);
    } catch(e) {
        console.error('Failed to parse Django data:', e);
    }
    
    var videoPath = djangoData.video_path;
    var prediction = djangoData.prediction;
    var apiCompleteUrl = djangoData.api_complete_url;
    var apiThreatUrl = djangoData.api_threat_url;
    
    if (videoPath) {
        // Load complete analysis
        fetch(apiCompleteUrl, {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({
                video_path: videoPath,
                prediction: prediction || {},
                enable_gradcam: true,
                enable_forensics: true,
                enable_timeline: true,
                enable_multimodal: true,
                enable_classification: true,
                enable_threat: true
            })
        })
        .then(function(r) { return r.json(); })
        .then(function(data) {
            if (data.timeline_data) {
                initTimelineChart(data.timeline_data);
            }
            if (data.timeline_stats) {
                document.getElementById('stat-mean').textContent = 
                    (data.timeline_stats.mean_fake_probability * 100).toFixed(1) + '%';
                document.getElementById('stat-variance').textContent = 
                    data.timeline_stats.temporal_variance.toFixed(3);
                document.getElementById('stat-consistency').textContent = 
                    data.timeline_stats.temporal_consistency_score.toFixed(1) + '%';
                document.getElementById('stat-anomalies').textContent = 
                    data.timeline_stats.anomaly_count;
            }
            if (data.forensics_metrics) {
                updateForensics(data.forensics_metrics);
            }
            // Trigger threat assessment
            return fetch(apiThreatUrl, {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({
                    prediction: prediction || {},
                    forensics: data.forensics_metrics,
                    multimodal: data.multimodal_analysis,
                    timeline: data.timeline_stats
                })
            });
        })
        .then(function(r) { return r.json(); })
        .then(function(threat) {
            updateThreat(threat);
        })
        .catch(function(err) { console.error(err); });
    }
});
</script>
{% endblock %}

{% block extra_css %}
<style>
.forensic-metric {
    text-align: center;
    padding: 15px;
    border: 1px solid #dee2e6;
    border-radius: 8px;
    margin-bottom: 10px;
}
.forensic-metric .metric-icon {
    font-size: 2rem;
    color: #6c757d;
    margin-bottom: 10px;
}
.forensic-metric .metric-label {
    font-weight: bold;
    margin-bottom: 5px;
}
.forensic-metric .metric-value {
    font-size: 1.5rem;
    color: #007bff;
    margin-bottom: 10px;
}
.stat-box {
    text-align: center;
    padding: 10px;
    background: #f8f9fa;
    border-radius: 5px;
}
.stat-box .stat-label {
    display: block;
    font-size: 0.8rem;
    color: #6c757d;
}
.stat-box .stat-value {
    display: block;
    font-size: 1.2rem;
    font-weight: bold;
    color: #343a40;
}
.gradcam-img {
    cursor: pointer;
    transition: transform 0.2s;
    border-radius: 5px;
}
.gradcam-img:hover {
    transform: scale(1.05);
}
.ethics-summary {
    background: #f8f9fa;
    padding: 15px;
    border-radius: 5px;
    white-space: pre-wrap;
    font-family: monospace;
    font-size: 0.85rem;
}
</style>
{% endblock %}
