// Prisma Schema for VerifyAI Identity Verification Platform
// Database: PostgreSQL (recommended for production)

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ============================================
// USER MANAGEMENT & AUTHENTICATION
// ============================================

enum UserRole {
  USER
  ADMIN
  REVIEWER
  ANALYST
}

enum AccountStatus {
  ACTIVE
  SUSPENDED
  PENDING_VERIFICATION
  DEACTIVATED
}

model User {
  id                String         @id @default(cuid())
  email             String         @unique
  emailVerified     Boolean        @default(false)
  passwordHash      String
  firstName         String?
  lastName          String?
  phone             String?
  phoneVerified     Boolean        @default(false)
  role              UserRole       @default(USER)
  status            AccountStatus  @default(PENDING_VERIFICATION)
  
  // Profile
  dateOfBirth       DateTime?
  nationality       String?
  address           String?
  city              String?
  state             String?
  country           String?
  postalCode        String?
  
  // Metadata
  createdAt         DateTime       @default(now())
  updatedAt         DateTime       @updatedAt
  lastLoginAt       DateTime?
  
  // Two-Factor Authentication
  twoFactorEnabled  Boolean        @default(false)
  twoFactorSecret   String?
  
  // Relations
  sessions          Session[]
  verificationSessions VerificationSession[]
  videoKycSessions  VideoKYCSession[]
  sessionActions    SessionAction[]
  ekycSessions      EkycSession[]
  
  @@index([email])
  @@index([status])
  @@map("users")
}

model Session {
  id           String   @id @default(cuid())
  userId       String
  token        String   @unique
  refreshToken String?  @unique
  ipAddress    String?
  userAgent    String?
  expiresAt    DateTime
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt
  
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  @@index([userId])
  @@index([token])
  @@map("sessions")
}

// ============================================
// FEATURE-SPECIFIC VERIFICATION SESSIONS
// ============================================

enum VerificationDecision {
  APPROVED
  REJECTED
  MANUAL_REVIEW
  PENDING
}

model VerificationSession {
  id            String              @id @default(cuid())
  userId        String
  documentPath  String?
  selfiePath    String?
  
  // Session Status & Type
  status        String              @default("started") // started, running, completed, failed
  featureType   String?             // deepfake, face_matching, document_verification, etc.
  
  // Feature Scores
  forgeryScore      Float?          // 0-100 (Fake Document Detection)
  faceMatchScore    Float?          // 0-100 (Face Matching)
  deepfakeScore     Float?          // 0-100 (Deepfake Detection)
  riskScore         Float?          // 0-1000 (Risk Scoring)
  
  // Final Decision
  decision          VerificationDecision @default(PENDING)
  
  // Metadata
  createdAt         DateTime        @default(now())
  updatedAt         DateTime        @updatedAt
  completedAt       DateTime?
  
  // Relations
  user              User            @relation(fields: [userId], references: [id], onDelete: Cascade)
  featureResults    FeatureResult[]
  deepfakeResults   DeepfakeResult[]
  sessionActions    SessionAction[]
  
  @@index([userId])
  @@index([createdAt])
  @@index([status])
  @@index([featureType])
  @@map("verification_sessions")
}

model SessionAction {
  id          String   @id @default(cuid())
  sessionId   String
  userId      String
  action      String   // RUN_ANALYSIS, VIEW_RESULT, UPLOAD_FILE, etc.
  metadata    Json?    // Additional context about the action
  createdAt   DateTime @default(now())
  
  // Relations
  session     VerificationSession @relation(fields: [sessionId], references: [id], onDelete: Cascade)
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  @@index([sessionId])
  @@index([userId])
  @@index([createdAt])
  @@index([action])
  @@map("session_actions")
}

model DeepfakeResult {
  id          String   @id @default(cuid())
  sessionId   String
  score       Float
  decision    String   // REAL or FAKE
  modelVersion String
  framesAnalyzed Int?
  metadata    Json?
  createdAt   DateTime @default(now())
  
  session     VerificationSession @relation(fields: [sessionId], references: [id], onDelete: Cascade)
  
  @@index([sessionId])
  @@index([decision])
  @@map("deepfake_results")
}

// ============================================
// VIDEO KYC VERIFICATION SYSTEM
// ============================================

enum VideoKYCStatus {
  IDLE
  IN_PROGRESS
  DOCUMENT_VERIFICATION
  AI_ANALYSIS
  AGENT_REVIEW
  COMPLETED
  REJECTED
  EXPIRED
}

model VideoKYCSession {
  id                    String            @id @default(cuid())
  userId                String
  sessionStatus         VideoKYCStatus    @default(IDLE)
  
  // Session Metadata
  sessionStartedAt      DateTime          @default(now())
  sessionCompletedAt    DateTime?
  
  // Progress Tracking
  currentStep           Int               @default(0)
  totalSteps            Int               @default(0)
  
  // Collected KYC Data
  name                  String?
  dateOfBirth           String?
  address               String?
  income                String?
  employment            String?
  aadhar                String?
  pan                   String?
  
  // Uploaded Files (stored paths)
  profileImagePath      String?
  signatureImagePath    String?
  documentImagePath     String?
  
  // Verification Results
  documentVerified      Boolean           @default(false)
  faceMatched           Boolean           @default(false)
  livenessChecked       Boolean           @default(false)
  riskScore             Float?
  
  // AI Analysis Results
  forgeryScore          Float?
  faceMatchScore        Float?
  deepfakeScore         Float?
  
  // Agent Review
  agentName             String?
  agentReviewNotes      String?
  reviewedAt            DateTime?
  
  // Final Decision
  finalDecision         VerificationDecision @default(PENDING)
  rejectionReason       String?
  
  // Geolocation & Device Info
  ipAddress             String?
  userAgent             String?
  deviceInfo            Json?
  
  // Relations
  user                  User              @relation(fields: [userId], references: [id], onDelete: Cascade)
  questions             VideoKYCQuestion[]
  answers               VideoKYCAnswer[]
  verificationResults   VideoKYCVerificationResult[]
  chatMessages          VideoKYCChatMessage[]
  
  @@index([userId])
  @@index([sessionStatus])
  @@index([sessionStartedAt])
  @@map("video_kyc_sessions")
}

model VideoKYCQuestion {
  id                    String            @id @default(cuid())
  sessionId             String
  
  // Question Details
  questionText          String
  questionType          String            // name, dob, address, income, etc.
  questionOrder         Int
  
  // Validation Rules
  validationRules       Json?
  required              Boolean           @default(true)
  
  // Metadata
  askedAt               DateTime          @default(now())
  
  // Relations
  session               VideoKYCSession   @relation(fields: [sessionId], references: [id], onDelete: Cascade)
  answer                VideoKYCAnswer?
  
  @@index([sessionId])
  @@index([questionOrder])
  @@map("video_kyc_questions")
}

model VideoKYCAnswer {
  id                    String            @id @default(cuid())
  sessionId             String
  questionId            String            @unique
  
  // Answer Details
  answerText            String?
  answerType            String            // text, image, audio
  
  // Media Storage
  imageUrl              String?
  audioUrl              String?
  
  // Validation
  isValid               Boolean           @default(true)
  validationErrors      Json?
  
  // Metadata
  answeredAt            DateTime          @default(now())
  responseTime          Int?              // in seconds
  
  // Relations
  session               VideoKYCSession   @relation(fields: [sessionId], references: [id], onDelete: Cascade)
  question              VideoKYCQuestion  @relation(fields: [questionId], references: [id], onDelete: Cascade)
  
  @@index([sessionId])
  @@index([questionId])
  @@map("video_kyc_answers")
}

model VideoKYCVerificationResult {
  id                    String            @id @default(cuid())
  sessionId             String
  
  // Verification Type
  verificationType      String            // document, face_match, liveness, deepfake, risk
  
  // Scores
  score                 Float
  confidence            Float?
  
  // Results
  isPassed              Boolean
  details               Json?
  
  // Metadata
  modelVersion          String?
  processedAt           DateTime          @default(now())
  processingTime        Int?              // in milliseconds
  
  // Relations
  session               VideoKYCSession   @relation(fields: [sessionId], references: [id], onDelete: Cascade)
  
  @@index([sessionId])
  @@index([verificationType])
  @@map("video_kyc_verification_results")
}

model VideoKYCChatMessage {
  id                    String            @id @default(cuid())
  sessionId             String
  
  // Message Details
  messageText           String
  messageType           String            // agent, user, system
  
  // Metadata
  timestamp             DateTime          @default(now())
  
  // Relations
  session               VideoKYCSession   @relation(fields: [sessionId], references: [id], onDelete: Cascade)
  
  @@index([sessionId])
  @@index([timestamp])
  @@map("video_kyc_chat_messages")
}

model FeatureResult {
  id            String              @id @default(cuid())
  sessionId     String
  featureName   String              // 'fake_document', 'face_matching', 'deepfake', 'risk_scoring'
  score         Float               // Feature-specific score
  metadata      Json?               // Additional feature-specific data
  
  // Metadata
  createdAt     DateTime            @default(now())
  
  // Relations
  session       VerificationSession @relation(fields: [sessionId], references: [id], onDelete: Cascade)
  
  @@index([sessionId])
  @@index([featureName])
  @@map("feature_results")
}

// ============================================
// E-KYC VERIFICATION SYSTEM
// ============================================

enum EkycStatus {
  PENDING
  DOCUMENT_UPLOADED
  SELFIE_UPLOADED
  PROCESSING
  COMPLETED
  FAILED
  MANUAL_REVIEW
}

enum EkycDecision {
  APPROVED
  REJECTED
  REVIEW_REQUIRED
  PENDING
}

enum DocumentType {
  PASSPORT
  DRIVERS_LICENSE
  NATIONAL_ID
  RESIDENCE_PERMIT
  VOTER_ID
}

model EkycSession {
  id                    String            @id @default(cuid())
  userId                String
  sessionId             String            @unique @default(cuid())
  status                EkycStatus        @default(PENDING)
  decision              EkycDecision      @default(PENDING)
  
  // Session Metadata
  ipAddress             String?
  userAgent             String?
  
  // Scores
  documentScore         Float?            // Document authenticity score (0-100)
  faceMatchScore        Float?            // Face matching score (0-100)
  livenessScore         Float?            // Liveness detection score (0-100)
  overallScore          Float?            // Combined risk score (0-100)
  
  // Decision Details
  rejectionReason       String?
  reviewNotes           String?
  
  // Timestamps
  createdAt             DateTime          @default(now())
  updatedAt             DateTime          @updatedAt
  completedAt           DateTime?
  
  // Relations
  user                  User              @relation(fields: [userId], references: [id], onDelete: Cascade)
  documents             EkycDocument[]
  results               EkycResult[]
  
  @@index([userId])
  @@index([sessionId])
  @@index([status])
  @@index([createdAt])
  @@map("ekyc_sessions")
}

model EkycDocument {
  id                    String            @id @default(cuid())
  sessionId             String
  type                  DocumentType
  
  // File Storage
  frontImageUrl         String
  backImageUrl          String?
  
  // Extracted Data
  documentNumber        String?
  fullName              String?
  dateOfBirth           String?
  expiryDate            String?
  issuingCountry        String?
  extractedData         Json?             // Full OCR data
  
  // Verification Results
  isAuthentic           Boolean?
  confidenceScore       Float?
  tamperingDetected     Boolean           @default(false)
  
  // Metadata
  uploadedAt            DateTime          @default(now())
  processedAt           DateTime?
  
  // Relations
  session               EkycSession       @relation(fields: [sessionId], references: [id], onDelete: Cascade)
  
  @@index([sessionId])
  @@map("ekyc_documents")
}

model EkycResult {
  id                    String            @id @default(cuid())
  sessionId             String
  
  // Verification Type
  verificationType      String            // 'document_auth', 'face_match', 'liveness'
  
  // Results
  score                 Float
  isPassed              Boolean
  confidence            Float?
  details               Json?
  
  // Metadata
  modelVersion          String?
  processedAt           DateTime          @default(now())
  processingTime        Int?              // milliseconds
  
  // Relations
  session               EkycSession       @relation(fields: [sessionId], references: [id], onDelete: Cascade)
  
  @@index([sessionId])
  @@index([verificationType])
  @@map("ekyc_results")
}

