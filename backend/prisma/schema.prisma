// Prisma Schema for VerifyAI Identity Verification Platform
// Database: PostgreSQL (recommended for production)

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ============================================
// USER MANAGEMENT & AUTHENTICATION
// ============================================

enum UserRole {
  USER
  ADMIN
  REVIEWER
  ANALYST
}

enum AccountStatus {
  ACTIVE
  SUSPENDED
  PENDING_VERIFICATION
  DEACTIVATED
}

model User {
  id                String         @id @default(cuid())
  email             String         @unique
  emailVerified     Boolean        @default(false)
  passwordHash      String
  firstName         String?
  lastName          String?
  phone             String?
  phoneVerified     Boolean        @default(false)
  role              UserRole       @default(USER)
  status            AccountStatus  @default(PENDING_VERIFICATION)
  
  // Profile
  dateOfBirth       DateTime?
  nationality       String?
  address           String?
  city              String?
  state             String?
  country           String?
  postalCode        String?
  
  // Metadata
  createdAt         DateTime       @default(now())
  updatedAt         DateTime       @updatedAt
  lastLoginAt       DateTime?
  
  // Two-Factor Authentication
  twoFactorEnabled  Boolean        @default(false)
  twoFactorSecret   String?
  
  // Relations
  sessions          Session[]
  verifications     Verification[]
  documents         Document[]
  auditLogs         AuditLog[]
  apiKeys           ApiKey[]
  verificationSessions VerificationSession[]
  
  @@index([email])
  @@index([status])
  @@map("users")
}

model Session {
  id           String   @id @default(cuid())
  userId       String
  token        String   @unique
  refreshToken String?  @unique
  ipAddress    String?
  userAgent    String?
  expiresAt    DateTime
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt
  
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  @@index([userId])
  @@index([token])
  @@map("sessions")
}

// ============================================
// KYC VERIFICATION PROCESS
// ============================================

enum VerificationStatus {
  PENDING
  IN_PROGRESS
  COMPLETED
  REJECTED
  MANUAL_REVIEW
  EXPIRED
}

enum VerificationLevel {
  BASIC           // Email + Phone
  STANDARD        // Basic + Document
  ENHANCED        // Standard + Face Match
  PREMIUM         // Enhanced + Liveness + AML
}

enum RiskLevel {
  LOW
  MEDIUM
  HIGH
  CRITICAL
}

model Verification {
  id                    String              @id @default(cuid())
  userId                String
  status                VerificationStatus  @default(PENDING)
  level                 VerificationLevel   @default(STANDARD)
  riskLevel             RiskLevel?
  riskScore             Float?              // 0-100
  
  // Verification Steps
  emailVerified         Boolean             @default(false)
  phoneVerified         Boolean             @default(false)
  documentVerified      Boolean             @default(false)
  faceVerified          Boolean             @default(false)
  livenessVerified      Boolean             @default(false)
  amlCheckCompleted     Boolean             @default(false)
  
  // Metadata
  startedAt             DateTime            @default(now())
  completedAt           DateTime?
  expiresAt             DateTime?
  reviewedBy            String?
  reviewedAt            DateTime?
  rejectionReason       String?
  
  // Geolocation
  ipAddress             String?
  country               String?
  region                String?
  
  // Relations
  user                  User                @relation(fields: [userId], references: [id], onDelete: Cascade)
  documents             Document[]
  faceMatches           FaceMatch[]
  livenessChecks        LivenessCheck[]
  amlChecks             AMLCheck[]
  fraudChecks           FraudCheck[]
  riskAssessments       RiskAssessment[]
  
  @@index([userId])
  @@index([status])
  @@index([riskLevel])
  @@map("verifications")
}

// ============================================
// DOCUMENT VERIFICATION
// ============================================

enum DocumentType {
  PASSPORT
  DRIVERS_LICENSE
  NATIONAL_ID
  RESIDENCE_PERMIT
  VOTER_ID
  UTILITY_BILL
  BANK_STATEMENT
  OTHER
}

enum DocumentStatus {
  PENDING
  PROCESSING
  VERIFIED
  REJECTED
  EXPIRED
}

model Document {
  id                    String          @id @default(cuid())
  userId                String
  verificationId        String?
  type                  DocumentType
  status                DocumentStatus  @default(PENDING)
  
  // Document Details
  documentNumber        String?
  issuingCountry        String?
  issuingAuthority      String?
  issueDate             DateTime?
  expiryDate            DateTime?
  
  // File Storage
  frontImageUrl         String
  backImageUrl          String?
  faceImageUrl          String?
  
  // OCR Extracted Data
  extractedData         Json?           // Structured data from OCR
  fullName              String?
  dateOfBirth           DateTime?
  gender                String?
  address               String?
  
  // Verification Results
  isAuthentic           Boolean?
  confidenceScore       Float?          // 0-100
  tamperingDetected     Boolean         @default(false)
  securityFeaturesValid Boolean?
  
  // Fraud Detection
  isFake                Boolean         @default(false)
  fraudIndicators       Json?
  
  // Metadata
  uploadedAt            DateTime        @default(now())
  processedAt           DateTime?
  verifiedAt            DateTime?
  rejectionReason       String?
  
  // Relations
  user                  User            @relation(fields: [userId], references: [id], onDelete: Cascade)
  verification          Verification?   @relation(fields: [verificationId], references: [id])
  
  @@index([userId])
  @@index([verificationId])
  @@index([status])
  @@map("documents")
}

// ============================================
// FACE VERIFICATION & LIVENESS
// ============================================

enum FaceMatchStatus {
  PENDING
  MATCHED
  NOT_MATCHED
  FAILED
}

model FaceMatch {
  id                    String           @id @default(cuid())
  verificationId        String
  status                FaceMatchStatus  @default(PENDING)
  
  // Face Images
  sourceImageUrl        String           // From document
  targetImageUrl        String           // Selfie/live capture
  
  // Match Results
  matchScore            Float?           // 0-100
  isMatch               Boolean?
  confidenceLevel       Float?
  
  // Biometric Data
  faceDescriptor        Json?            // Face encoding/embedding
  faceQuality           Float?
  
  // Detection Results
  facesDetected         Int              @default(0)
  multipleFacesDetected Boolean          @default(false)
  
  // Metadata
  createdAt             DateTime         @default(now())
  processedAt           DateTime?
  
  // Relations
  verification          Verification     @relation(fields: [verificationId], references: [id], onDelete: Cascade)
  
  @@index([verificationId])
  @@map("face_matches")
}

enum LivenessStatus {
  PENDING
  PASSED
  FAILED
  SUSPICIOUS
}

model LivenessCheck {
  id                    String          @id @default(cuid())
  verificationId        String
  status                LivenessStatus  @default(PENDING)
  
  // Check Details
  videoUrl              String?
  framesAnalyzed        Int?
  
  // Detection Results
  isLive                Boolean?
  confidenceScore       Float?          // 0-100
  
  // Deepfake Detection
  deepfakeDetected      Boolean         @default(false)
  deepfakeScore         Float?
  syntheticFaceDetected Boolean         @default(false)
  
  // Challenge-Response
  challengeType         String?         // blink, smile, turn_head, etc.
  challengePassed       Boolean?
  
  // Metadata
  createdAt             DateTime        @default(now())
  processedAt           DateTime?
  
  // Relations
  verification          Verification    @relation(fields: [verificationId], references: [id], onDelete: Cascade)
  
  @@index([verificationId])
  @@map("liveness_checks")
}

// ============================================
// AML & COMPLIANCE CHECKS
// ============================================

enum AMLStatus {
  PENDING
  CLEAR
  HIT
  MANUAL_REVIEW
  FAILED
}

model AMLCheck {
  id                    String      @id @default(cuid())
  verificationId        String
  status                AMLStatus   @default(PENDING)
  
  // Check Details
  fullName              String
  dateOfBirth           DateTime?
  nationality           String?
  
  // Screening Results
  sanctionsHit          Boolean     @default(false)
  pepHit                Boolean     @default(false)      // Politically Exposed Person
  adverseMediaHit       Boolean     @default(false)
  
  // Match Details
  matchedEntities       Json?       // List of matched entities
  matchScore            Float?
  
  // Watchlist Sources
  ofacChecked           Boolean     @default(false)     // US OFAC
  unChecked             Boolean     @default(false)     // UN Sanctions
  euChecked             Boolean     @default(false)     // EU Sanctions
  interpolChecked       Boolean     @default(false)
  
  // Metadata
  createdAt             DateTime    @default(now())
  completedAt           DateTime?
  reviewedBy            String?
  reviewNotes           String?
  
  // Relations
  verification          Verification @relation(fields: [verificationId], references: [id], onDelete: Cascade)
  
  @@index([verificationId])
  @@index([status])
  @@map("aml_checks")
}

// ============================================
// FRAUD DETECTION & RISK SCORING
// ============================================

enum FraudCheckStatus {
  PENDING
  CLEAR
  SUSPICIOUS
  FRAUD_DETECTED
}

model FraudCheck {
  id                    String            @id @default(cuid())
  verificationId        String
  status                FraudCheckStatus  @default(PENDING)
  
  // Fraud Indicators
  ipRiskScore           Float?
  emailRiskScore        Float?
  phoneRiskScore        Float?
  deviceRiskScore       Float?
  behaviorRiskScore     Float?
  
  // Detection Results
  vpnDetected           Boolean           @default(false)
  proxyDetected         Boolean           @default(false)
  emulatorDetected      Boolean           @default(false)
  suspiciousActivity    Boolean           @default(false)
  
  // Geolocation Mismatch
  ipCountry             String?
  documentCountry       String?
  countryMismatch       Boolean           @default(false)
  
  // Duplicate Detection
  duplicateEmail        Boolean           @default(false)
  duplicatePhone        Boolean           @default(false)
  duplicateDocument     Boolean           @default(false)
  duplicateFace         Boolean           @default(false)
  
  // Metadata
  details               Json?             // Additional fraud signals
  createdAt             DateTime          @default(now())
  
  // Relations
  verification          Verification      @relation(fields: [verificationId], references: [id], onDelete: Cascade)
  
  @@index([verificationId])
  @@map("fraud_checks")
}

model RiskAssessment {
  id                    String       @id @default(cuid())
  verificationId        String
  
  // Overall Risk
  overallRiskScore      Float        // 0-100
  riskLevel             RiskLevel
  recommendation        String       // APPROVE, REJECT, MANUAL_REVIEW
  
  // Component Scores
  documentRiskScore     Float?
  faceRiskScore         Float?
  amlRiskScore          Float?
  fraudRiskScore        Float?
  behaviorRiskScore     Float?
  
  // Factors
  positiveFactors       Json?        // Factors reducing risk
  negativeFactors       Json?        // Factors increasing risk
  
  // Decision
  autoDecision          Boolean      @default(false)
  requiresReview        Boolean      @default(false)
  reviewPriority        String?      // LOW, MEDIUM, HIGH, CRITICAL
  
  // Metadata
  calculatedAt          DateTime     @default(now())
  modelVersion          String?
  
  // Relations
  verification          Verification @relation(fields: [verificationId], references: [id], onDelete: Cascade)
  
  @@index([verificationId])
  @@index([riskLevel])
  @@map("risk_assessments")
}

// ============================================
// FEATURE-SPECIFIC VERIFICATION SESSIONS
// ============================================

enum VerificationDecision {
  APPROVED
  REJECTED
  MANUAL_REVIEW
  PENDING
}

model VerificationSession {
  id            String              @id @default(cuid())
  userId        String
  documentPath  String?
  selfiePath    String?
  
  // Feature Scores
  forgeryScore      Float?          // 0-100 (Fake Document Detection)
  faceMatchScore    Float?          // 0-100 (Face Matching)
  deepfakeScore     Float?          // 0-100 (Deepfake Detection)
  riskScore         Float?          // 0-1000 (Risk Scoring)
  
  // Final Decision
  decision          VerificationDecision @default(PENDING)
  
  // Metadata
  createdAt         DateTime        @default(now())
  updatedAt         DateTime        @updatedAt
  
  // Relations
  user              User            @relation(fields: [userId], references: [id], onDelete: Cascade)
  featureResults    FeatureResult[]
  
  @@index([userId])
  @@index([createdAt])
  @@map("verification_sessions")
}

model DeepfakeResult {
  id          String   @id @default(cuid())
  sessionId   String
  score       Float
  decision    String   // REAL or FAKE
  modelVersion String
  framesAnalyzed Int?
  metadata    Json?
  createdAt   DateTime @default(now())
  
  session     VerificationSession @relation(fields: [sessionId], references: [id], onDelete: Cascade)
  
  @@index([sessionId])
  @@index([decision])
  @@map("deepfake_results")
}

model FeatureResult {
  id            String              @id @default(cuid())
  sessionId     String
  featureName   String              // 'fake_document', 'face_matching', 'deepfake', 'risk_scoring'
  score         Float               // Feature-specific score
  metadata      Json?               // Additional feature-specific data
  
  // Metadata
  createdAt     DateTime            @default(now())
  
  // Relations
  session       VerificationSession @relation(fields: [sessionId], references: [id], onDelete: Cascade)
  
  @@index([sessionId])
  @@index([featureName])
  @@map("feature_results")
}

// ============================================
// AUDIT & COMPLIANCE LOGGING
// ============================================

enum AuditAction {
  USER_CREATED
  USER_UPDATED
  USER_DELETED
  USER_LOGIN
  USER_LOGOUT
  VERIFICATION_STARTED
  VERIFICATION_COMPLETED
  DOCUMENT_UPLOADED
  DOCUMENT_VERIFIED
  FACE_MATCHED
  LIVENESS_CHECKED
  AML_CHECKED
  RISK_ASSESSED
  MANUAL_REVIEW
  STATUS_CHANGED
  DATA_EXPORTED
  API_KEY_CREATED
  API_KEY_REVOKED
}

model AuditLog {
  id           String      @id @default(cuid())
  userId       String?
  action       AuditAction
  resource     String?     // Resource type (User, Document, etc.)
  resourceId   String?     // ID of affected resource
  
  // Request Details
  ipAddress    String?
  userAgent    String?
  method       String?     // HTTP method
  endpoint     String?     // API endpoint
  
  // Changes
  oldValue     Json?
  newValue     Json?
  
  // Metadata
  success      Boolean     @default(true)
  errorMessage String?
  createdAt    DateTime    @default(now())
  
  // Relations
  user         User?       @relation(fields: [userId], references: [id], onDelete: SetNull)
  
  @@index([userId])
  @@index([action])
  @@index([createdAt])
  @@map("audit_logs")
}

// ============================================
// API MANAGEMENT
// ============================================

enum ApiKeyStatus {
  ACTIVE
  REVOKED
  EXPIRED
}

model ApiKey {
  id           String       @id @default(cuid())
  userId       String
  name         String
  key          String       @unique
  status       ApiKeyStatus @default(ACTIVE)
  
  // Permissions
  permissions  Json?        // Scoped permissions
  
  // Usage Tracking
  lastUsedAt   DateTime?
  requestCount Int          @default(0)
  
  // Limits
  rateLimit    Int?         // Requests per minute
  expiresAt    DateTime?
  
  // Metadata
  createdAt    DateTime     @default(now())
  revokedAt    DateTime?
  
  // Relations
  user         User         @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  @@index([userId])
  @@index([key])
  @@map("api_keys")
}

// ============================================
// ANALYTICS & REPORTING
// ============================================

model VerificationMetrics {
  id                    String   @id @default(cuid())
  date                  DateTime @default(now())
  
  // Volume Metrics
  totalVerifications    Int      @default(0)
  completedVerifications Int     @default(0)
  rejectedVerifications Int      @default(0)
  pendingVerifications  Int      @default(0)
  
  // Success Rates
  approvalRate          Float?   // Percentage
  rejectionRate         Float?
  manualReviewRate      Float?
  
  // Average Scores
  avgRiskScore          Float?
  avgDocumentScore      Float?
  avgFaceMatchScore     Float?
  
  // Processing Times
  avgProcessingTime     Int?     // Seconds
  
  // Fraud Detection
  fraudDetected         Int      @default(0)
  fraudRate             Float?
  
  @@index([date])
  @@map("verification_metrics")
}
